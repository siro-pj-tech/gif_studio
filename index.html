<!-- 
  GIF Studio Ver.1.1
  A client-side GIF creator application.
  
  Created with:
  - Gifshot (MIT License) - https://github.com/yahoo/gifshot
  - Tailwind CSS (MIT License) - https://tailwindcss.com/
  - Lucide Icons (ISC License) - https://lucide.dev/
  - Google Fonts (Inter) - SIL Open Font License
-->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF Studio Ver.1.1</title>
    <meta name="description" content="ブラウザ上で高品質なアニメーションGIFを作成できるツール">
    
    <!-- スタイルシート (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- アイコン (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- GIF生成エンジン (Gifshot - 最新版v0.4.5) -->
    <!-- 予備としてheadでも読み込みを試みます -->
    <script src="https://unpkg.com/gifshot@0.4.5/dist/gifshot.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* スライダーのカスタマイズ */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            margin-top: -8px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #E2E8F0;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        
        <!-- ヘッダー -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-black text-indigo-600 mb-2 flex items-center justify-center gap-2">
                <i data-lucide="image" class="w-10 h-10"></i>
                GIF Studio <span class="text-sm font-medium text-slate-400 mt-2 ml-1">Ver.1.1</span>
            </h1>
            <p class="text-slate-500 text-sm md:text-base">高品質なアニメーションGIFをブラウザで作成</p>
            
            <!-- エンジンステータス表示 -->
            <div class="mt-2 flex justify-center items-center gap-2 text-xs">
                <span id="engine-status-indicator" class="w-2 h-2 rounded-full bg-slate-300"></span>
                <span id="engine-status-text" class="text-slate-400">エンジン準備中...</span>
            </div>
        </header>

        <!-- エラー表示エリア -->
        <div id="error-container" class="hidden mb-6 max-w-2xl mx-auto bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-xl flex items-center gap-3">
            <i data-lucide="alert-circle" class="w-5 h-5 shrink-0"></i>
            <div class="flex-1">
                <p id="error-message" class="text-sm font-medium"></p>
                <button id="retry-btn" onclick="loadEngine()" class="hidden mt-2 text-xs bg-red-100 px-3 py-1 rounded-full hover:bg-red-200 font-bold">
                    再接続を試みる
                </button>
            </div>
            <button onclick="hideError()" class="ml-auto hover:bg-red-100 p-1 rounded self-start">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- メインコンテンツエリア -->
        <main id="main-view" class="grid grid-cols-1 lg:grid-cols-3 gap-8 transition-opacity duration-500">
            
            <!-- 左カラム: アップロード & フレームリスト -->
            <div class="lg:col-span-2 space-y-6">
                <!-- アップロードエリア -->
                <div 
                    id="drop-zone"
                    class="border-2 border-dashed border-slate-300 bg-white rounded-2xl p-8 text-center hover:border-indigo-400 hover:bg-indigo-50 transition-all cursor-pointer group shadow-sm"
                    onclick="document.getElementById('file-input').click()"
                >
                    <input type="file" id="file-input" multiple accept="image/*" class="hidden">
                    <div class="text-slate-400 group-hover:text-indigo-500 transition-colors mb-3 flex justify-center">
                        <i data-lucide="upload" class="w-10 h-10"></i>
                    </div>
                    <p class="text-base font-bold text-slate-700">画像をアップロード</p>
                    <p class="text-xs text-slate-400 mt-1">PNG, JPG, WebPに対応</p>
                </div>

                <!-- フレームリストコンテナ -->
                <div id="frames-container" class="hidden bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-bold text-lg flex items-center gap-2">
                            フレーム管理 <span id="frame-count" class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs">0</span>
                        </h2>
                        <button onclick="clearAllFrames()" class="text-xs text-red-500 hover:text-red-600 font-bold uppercase tracking-wider">
                            全削除
                        </button>
                    </div>
                    
                    <!-- フレーム一覧 -->
                    <div id="frames-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        <!-- JSでここにフレームが追加されます -->
                    </div>
                </div>
            </div>

            <!-- 右カラム: 設定 -->
            <div class="space-y-6">
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 sticky top-4">
                    <h2 class="font-bold text-lg mb-5 flex items-center gap-2">
                        <i data-lucide="settings-2" class="w-5 h-5 text-indigo-500"></i>
                        書き出し設定
                    </h2>
                    
                    <div class="space-y-5">
                        <!-- 速度 -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-bold text-slate-600">切り替え速度</label>
                                <span id="interval-display" class="text-xs font-mono bg-slate-100 px-2 py-0.5 rounded text-indigo-600">0.2s</span>
                            </div>
                            <input type="range" id="interval-input" min="0.05" max="1" step="0.05" value="0.2" class="w-full">
                        </div>

                        <!-- サイズ (アスペクト比固定機能付き) -->
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">サイズ (px)</label>
                                <button id="aspect-ratio-btn" onclick="toggleAspectRatio()" class="flex items-center gap-1 text-[10px] px-2 py-1 rounded bg-indigo-50 text-indigo-600 border border-indigo-200 font-bold hover:bg-indigo-100 transition-colors" title="比率を固定/解除">
                                    <i data-lucide="link" class="w-3 h-3"></i>
                                    <span>比率固定</span>
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex-1">
                                    <label class="sr-only">幅</label>
                                    <input type="number" id="width-input" value="400" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500" placeholder="幅">
                                </div>
                                <div class="text-slate-300">×</div>
                                <div class="flex-1">
                                    <label class="sr-only">高さ</label>
                                    <input type="number" id="height-input" value="400" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500" placeholder="高さ">
                                </div>
                            </div>
                        </div>

                        <!-- 最後のフレームの待機時間 -->
                        <div class="pt-2 border-t border-slate-100">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-bold text-slate-600 flex items-center gap-1">
                                    最後のコマの停止時間
                                    <i data-lucide="timer" class="w-3 h-3 text-slate-400"></i>
                                </label>
                                <span id="last-delay-display" class="text-xs font-mono bg-indigo-50 px-2 py-0.5 rounded text-indigo-600 font-bold">0s</span>
                            </div>
                            <input type="range" id="last-delay-input" min="0" max="5" step="0.1" value="0" class="w-full accent-indigo-500">
                            <p class="text-[10px] text-slate-400 mt-1">※無限ループの繋ぎ目で指定秒数だけ停止します</p>
                        </div>
                    </div>

                    <!-- 生成ボタン -->
                    <button 
                        id="generate-btn"
                        onclick="generateGif()"
                        disabled
                        class="w-full mt-8 py-4 rounded-xl font-black text-sm uppercase tracking-widest flex items-center justify-center gap-3 transition-all shadow-lg bg-slate-100 text-slate-400 cursor-not-allowed"
                    >
                        <i data-lucide="play" class="w-5 h-5 fill-current"></i>
                        <span id="generate-btn-text">GIFを生成する</span>
                    </button>
                </div>
            </div>
        </main>

        <!-- 結果表示ビュー (初期状態は非表示) -->
        <section id="result-view" class="hidden max-w-2xl mx-auto animate-in zoom-in-95 fade-in duration-500">
            <div class="bg-white rounded-3xl p-8 shadow-xl border border-slate-200 text-center">
                <h2 class="text-2xl font-black text-slate-800 mb-6">生成が完了しました！</h2>
                
                <div class="rounded-2xl overflow-hidden bg-slate-900 border-4 border-white shadow-2xl flex items-center justify-center aspect-square mb-8 mx-auto max-w-md group">
                    <img id="preview-image" src="" alt="Generated Preview" class="max-w-full max-h-full object-contain">
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                    <button 
                        onclick="switchView('edit')"
                        class="flex-1 px-6 py-4 rounded-xl border-2 border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-all flex items-center justify-center gap-2"
                    >
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        編集に戻る
                    </button>
                    <button 
                        onclick="showSaveModal()"
                        class="flex-1 px-6 py-4 rounded-xl bg-emerald-500 text-white font-bold hover:bg-emerald-600 transition-all shadow-lg shadow-emerald-200 flex items-center justify-center gap-2"
                    >
                        <i data-lucide="download" class="w-5 h-5"></i>
                        保存する
                    </button>
                </div>
            </div>
        </section>

        <!-- 保存確認モーダル -->
        <div id="save-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl animate-in zoom-in-95 duration-200 border border-slate-100">
                <div class="w-16 h-16 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="alert-circle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800 text-center mb-2">保存しますか？</h3>
                <p class="text-slate-500 text-center text-sm mb-6 leading-relaxed">
                    以下のファイル名でダウンロードフォルダに保存されます：<br/>
                    <span id="filename-display" class="font-mono text-indigo-600 font-bold break-all">animation.gif</span>
                </p>
                <div class="flex gap-3">
                    <button 
                        onclick="closeSaveModal()"
                        class="flex-1 py-3 rounded-xl border border-slate-200 text-slate-500 font-bold hover:bg-slate-50 transition-all flex items-center justify-center gap-2"
                    >
                        <i data-lucide="x" class="w-4 h-4"></i>
                        いいえ
                    </button>
                    <button 
                        onclick="confirmDownload()"
                        class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 flex items-center justify-center gap-2"
                    >
                        <i data-lucide="check" class="w-4 h-4"></i>
                        はい
                    </button>
                </div>
            </div>
        </div>

        <footer class="mt-16 text-center text-slate-400 text-xs">
            <!-- 年号をJavaScriptで自動更新するように変更 -->
            <p>© <span id="copyright-year"></span> GIF Studio - Your Creative GIF Workshop</p>
        </footer>

    </div>

    <!-- アプリケーションロジック -->
    <script>
        // コピーライトの年号を動的に設定
        document.getElementById('copyright-year').textContent = new Date().getFullYear();

        // 状態変数
        let frames = [];
        let generatedGifUrl = null;
        let generatedFilename = '';
        let isGenerating = false;
        let isAspectRatioLocked = true; // アスペクト比固定フラグ
        let currentAspectRatio = 1;     // 現在のアスペクト比 (width / height)

        // CDNリスト（優先順: unpkg, jsdelivr, yahoo github page）
        // バージョンを0.4.5に更新してループ設定の不具合を修正
        const ENGINE_URLS = [
            "https://unpkg.com/gifshot@0.4.5/dist/gifshot.min.js",
            "https://cdn.jsdelivr.net/npm/gifshot@0.4.5/dist/gifshot.min.js",
            "https://yahoo.github.io/gifshot/js/gifshot.min.js"
        ];
        let currentEngineIndex = 0;

        // DOM要素
        const fileInput = document.getElementById('file-input');
        const framesContainer = document.getElementById('frames-container');
        const framesList = document.getElementById('frames-list');
        const frameCount = document.getElementById('frame-count');
        const generateBtn = document.getElementById('generate-btn');
        const generateBtnText = document.getElementById('generate-btn-text');
        
        // 設定入力
        const intervalInput = document.getElementById('interval-input');
        const intervalDisplay = document.getElementById('interval-display');
        const widthInput = document.getElementById('width-input');
        const heightInput = document.getElementById('height-input');
        const aspectRatioBtn = document.getElementById('aspect-ratio-btn');
        const lastDelayInput = document.getElementById('last-delay-input');
        const lastDelayDisplay = document.getElementById('last-delay-display');

        // ステータス表示要素
        const engineStatusIndicator = document.getElementById('engine-status-indicator');
        const engineStatusText = document.getElementById('engine-status-text');

        // 初期化
        window.onload = function() {
            lucide.createIcons();
            loadEngine(); // エンジンの読み込み開始
            updateAspectRatioBtn(); // ボタンの初期状態描画
        };

        // エンジン読み込みロジック (再帰的フォールバック)
        function loadEngine() {
            // すでに読み込まれているかチェック
            if (typeof gifshot !== 'undefined') {
                updateEngineStatus('ready');
                hideError();
                return;
            }

            if (currentEngineIndex >= ENGINE_URLS.length) {
                updateEngineStatus('error');
                showError("全てのサーバーでエンジンの読み込みに失敗しました。ファイアウォール設定を確認してください。", true);
                return;
            }

            updateEngineStatus('loading');
            
            const script = document.createElement('script');
            script.src = ENGINE_URLS[currentEngineIndex];
            script.async = true;
            
            script.onload = () => {
                console.log(`Engine loaded from: ${ENGINE_URLS[currentEngineIndex]}`);
                updateEngineStatus('ready');
                hideError();
                updateGenerateButton(); // ボタンの状態を更新
            };

            script.onerror = () => {
                console.warn(`Failed to load from: ${ENGINE_URLS[currentEngineIndex]}`);
                currentEngineIndex++;
                loadEngine(); // 次のURLを試す
            };

            document.head.appendChild(script);
        }

        function updateEngineStatus(status) {
            if (status === 'ready') {
                engineStatusIndicator.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]";
                engineStatusText.textContent = "エンジン準備完了";
                engineStatusText.className = "text-emerald-600 font-medium";
            } else if (status === 'loading') {
                engineStatusIndicator.className = "w-2 h-2 rounded-full bg-yellow-400 animate-pulse";
                engineStatusText.textContent = "エンジン接続中...";
                engineStatusText.className = "text-yellow-600";
            } else {
                engineStatusIndicator.className = "w-2 h-2 rounded-full bg-red-500";
                engineStatusText.textContent = "エンジンエラー";
                engineStatusText.className = "text-red-500 font-bold";
            }
        }

        // イベントリスナー設定
        fileInput.addEventListener('change', handleFileSelect);
        
        // 設定変更の反映
        intervalInput.addEventListener('input', (e) => {
            intervalDisplay.textContent = `${e.target.value}s`;
        });

        lastDelayInput.addEventListener('input', (e) => {
            lastDelayDisplay.textContent = `${e.target.value}s`;
        });

        // アスペクト比固定トグル
        function toggleAspectRatio() {
            isAspectRatioLocked = !isAspectRatioLocked;
            
            if (isAspectRatioLocked) {
                // ロックした瞬間に現在の比率を保存
                const w = parseInt(widthInput.value) || 0;
                const h = parseInt(heightInput.value) || 0;
                if (w > 0 && h > 0) {
                    currentAspectRatio = w / h;
                }
            }
            updateAspectRatioBtn();
        }

        function updateAspectRatioBtn() {
            // LucideアイコンがDOMを置き換えるため、innerHTMLごと再生成する
            const iconName = isAspectRatioLocked ? 'link' : 'unlink';
            const labelText = isAspectRatioLocked ? '比率固定ON' : '比率固定OFF';
            const btnClass = isAspectRatioLocked 
                ? "flex items-center gap-1 text-[10px] px-2 py-1 rounded bg-indigo-50 text-indigo-600 border border-indigo-200 font-bold hover:bg-indigo-100 transition-colors"
                : "flex items-center gap-1 text-[10px] px-2 py-1 rounded bg-slate-50 text-slate-400 border border-slate-200 font-bold hover:bg-slate-100 transition-colors";

            aspectRatioBtn.className = btnClass;
            aspectRatioBtn.innerHTML = `
                <i data-lucide="${iconName}" class="w-3 h-3"></i>
                <span>${labelText}</span>
            `;
            
            lucide.createIcons();
        }

        // 幅・高さの入力イベント（相互連動）
        widthInput.addEventListener('input', (e) => {
            if (isAspectRatioLocked) {
                const w = parseInt(e.target.value) || 0;
                if (w > 0) {
                    heightInput.value = Math.round(w / currentAspectRatio);
                }
            }
        });

        heightInput.addEventListener('input', (e) => {
            if (isAspectRatioLocked) {
                const h = parseInt(e.target.value) || 0;
                if (h > 0) {
                    widthInput.value = Math.round(h * currentAspectRatio);
                }
            }
        });

        // ファイル選択処理
        async function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            // 最初の1枚目のサイズを取得して設定に反映（まだフレームがない場合）
            if (frames.length === 0) {
                try {
                    const dims = await getImageDimensions(files[0]);
                    widthInput.value = dims.width;
                    heightInput.value = dims.height;
                    
                    // アスペクト比を計算し、ロックを有効化
                    currentAspectRatio = dims.width / dims.height;
                    isAspectRatioLocked = true;
                    updateAspectRatioBtn();
                    
                } catch (e) {
                    console.error("サイズ取得失敗", e);
                }
            }

            // フレーム追加
            files.forEach(file => {
                frames.push({
                    id: Math.random().toString(36).substr(2, 9),
                    url: URL.createObjectURL(file),
                    file: file
                });
            });

            fileInput.value = ''; // 入力をリセット
            renderFrames();
        }

        // 画像サイズ取得ヘルパー
        function getImageDimensions(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve({ width: img.naturalWidth, height: img.naturalHeight });
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // フレームリスト描画
        function renderFrames() {
            framesList.innerHTML = '';
            
            if (frames.length > 0) {
                framesContainer.classList.remove('hidden');
            } else {
                framesContainer.classList.add('hidden');
            }

            frameCount.textContent = frames.length;

            frames.forEach((frame, index) => {
                const el = document.createElement('div');
                el.className = 'relative group bg-slate-50 rounded-xl p-2 border border-slate-200 shadow-sm transition-all hover:shadow-md';
                el.innerHTML = `
                    <div class="aspect-square rounded-lg overflow-hidden bg-white mb-2 relative">
                        <img src="${frame.url}" class="w-full h-full object-contain">
                        <div class="absolute top-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded font-bold">#${index + 1}</div>
                    </div>
                    <div class="flex items-center justify-between gap-1">
                        <div class="flex gap-1">
                            <button onclick="moveFrame(${index}, -1)" ${index === 0 ? 'disabled' : ''} class="p-1.5 rounded-lg bg-white border border-slate-200 text-slate-600 hover:text-indigo-600 disabled:opacity-30">
                                <i data-lucide="arrow-left" class="w-3 h-3"></i>
                            </button>
                            <button onclick="moveFrame(${index}, 1)" ${index === frames.length - 1 ? 'disabled' : ''} class="p-1.5 rounded-lg bg-white border border-slate-200 text-slate-600 hover:text-indigo-600 disabled:opacity-30">
                                <i data-lucide="arrow-right" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <button onclick="removeFrame('${frame.id}')" class="p-1.5 rounded-lg bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-all">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </div>
                `;
                framesList.appendChild(el);
            });

            // 生成ボタンの状態更新
            updateGenerateButton();
            // アイコン再描画
            lucide.createIcons();
        }

        // フレーム操作
        function removeFrame(id) {
            frames = frames.filter(f => f.id !== id);
            renderFrames();
        }

        function clearAllFrames() {
            frames = [];
            renderFrames();
        }

        function moveFrame(index, direction) {
            const targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= frames.length) return;
            
            [frames[index], frames[targetIndex]] = [frames[targetIndex], frames[index]];
            renderFrames();
        }

        // 生成ボタンの有効/無効化
        function updateGenerateButton() {
            const isEngineReady = typeof gifshot !== 'undefined';
            const hasFrames = frames.length >= 2;
            const canGenerate = isEngineReady && hasFrames && !isGenerating;
            
            generateBtn.disabled = !canGenerate;
            
            if (canGenerate) {
                generateBtn.className = "w-full mt-8 py-4 rounded-xl font-black text-sm uppercase tracking-widest flex items-center justify-center gap-3 transition-all shadow-lg bg-indigo-600 text-white hover:bg-indigo-700 hover:-translate-y-0.5";
            } else {
                generateBtn.className = "w-full mt-8 py-4 rounded-xl font-black text-sm uppercase tracking-widest flex items-center justify-center gap-3 transition-all shadow-lg bg-slate-100 text-slate-400 cursor-not-allowed";
            }
        }

        // GIF生成処理
        function generateGif() {
            if (frames.length < 2 || typeof gifshot === 'undefined') {
                if (typeof gifshot === 'undefined') {
                    showError("エンジンがまだ読み込まれていません。再接続ボタンを押してください。", true);
                }
                return;
            }

            isGenerating = true;
            generateBtnText.textContent = "処理中...";
            updateGenerateButton();
            hideError();

            const width = parseInt(widthInput.value) || 400;
            const height = parseInt(heightInput.value) || 400;
            const interval = parseFloat(intervalInput.value) || 0.2;
            const loop = 0; // 仕様変更：無限ループ固定

            // 画像リストの作成
            let images = frames.map(f => f.url);

            // 最後のコマの停止時間処理
            const lastDelay = parseFloat(lastDelayInput.value) || 0;
            if (lastDelay > 0) {
                const extraFramesCount = Math.round(lastDelay / interval);
                if (extraFramesCount > 0) {
                    const lastImage = images[images.length - 1];
                    for (let i = 0; i < extraFramesCount; i++) {
                        images.push(lastImage);
                    }
                    console.log(`Added ${extraFramesCount} frames for delay.`);
                }
            }

            try {
                gifshot.createGIF({
                    images: images,
                    interval: interval,
                    gifWidth: width,
                    gifHeight: height,
                    numWorkers: 2,
                    loop: loop 
                }, function(obj) {
                    isGenerating = false;
                    generateBtnText.textContent = "GIFを生成する";
                    updateGenerateButton();

                    if (!obj.error) {
                        generatedGifUrl = obj.image;
                        generatedFilename = `animation-${Date.now()}.gif`;
                        document.getElementById('preview-image').src = generatedGifUrl;
                        switchView('result');
                    } else {
                        console.error(obj.error);
                        showError("GIF生成中にエラーが発生しました。画像サイズを小さくして試してください。");
                    }
                });
            } catch (e) {
                isGenerating = false;
                generateBtnText.textContent = "GIFを生成する";
                updateGenerateButton();
                showError("予期せぬエラーが発生しました: " + e.message);
            }
        }

        // ビュー切り替え
        function switchView(mode) {
            const mainView = document.getElementById('main-view');
            const resultView = document.getElementById('result-view');
            
            if (mode === 'result') {
                mainView.classList.add('hidden');
                resultView.classList.remove('hidden');
            } else {
                mainView.classList.remove('hidden');
                resultView.classList.add('hidden');
            }
        }

        // モーダル操作
        function showSaveModal() {
            document.getElementById('filename-display').textContent = generatedFilename;
            document.getElementById('save-modal').classList.remove('hidden');
        }

        function closeSaveModal() {
            document.getElementById('save-modal').classList.add('hidden');
            switchView('edit'); // 「いいえ」のときは編集に戻る
        }

        function confirmDownload() {
            if (!generatedGifUrl) return;
            const link = document.createElement('a');
            link.href = generatedGifUrl;
            link.download = generatedFilename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            document.getElementById('save-modal').classList.add('hidden');
        }

        // エラー表示
        function showError(msg, showRetry = false) {
            const container = document.getElementById('error-container');
            const message = document.getElementById('error-message');
            const retryBtn = document.getElementById('retry-btn');
            
            message.textContent = msg;
            container.classList.remove('hidden');
            
            if (showRetry) {
                retryBtn.classList.remove('hidden');
            } else {
                retryBtn.classList.add('hidden');
            }
        }

        function hideError() {
            document.getElementById('error-container').classList.add('hidden');
        }

    </script>
</body>
</html>